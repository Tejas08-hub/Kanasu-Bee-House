<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hive Health Report | Kanasu</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase.js"></script>

    <style>
         :root {
            --primary: #f4b400;
            --success: #2e7d32;
            --danger: #d32f2f;
            --dark: #1e293b;
            --bg: #f8fafc;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background: var(--bg);
            padding: 20px;
            color: var(--dark);
        }
        
        .report-container {
            max-width: 700px;
            margin: auto;
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }
        /* Top Header */
        
        .report-header {
            background: var(--dark);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .report-header h1 {
            font-size: 22px;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .report-header p {
            font-size: 13px;
            opacity: 0.7;
        }
        /* Health Status Bar */
        
        .status-bar {
            padding: 15px;
            text-align: center;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 14px;
            background: #f1f5f9;
        }
        
        .status-healthy {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-warning {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .content {
            padding: 30px;
        }
        /* Info Grid */
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-item {
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #f1f5f9;
        }
        
        .info-item label {
            display: block;
            font-size: 11px;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .info-item span {
            font-size: 18px;
            font-weight: 800;
        }
        /* ML Insights Section */
        
        .insight-box {
            background: #fff9e6;
            border: 1px solid var(--primary);
            padding: 20px;
            border-radius: 16px;
            margin-top: 20px;
        }
        
        .insight-box h3 {
            font-size: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* Buttons */
        
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            font-size: 14px;
        }
        
        .btn-print {
            background: var(--dark);
            color: white;
        }
        
        .btn-camera {
            background: var(--primary);
            color: var(--dark);
        }
        
        @media (max-width: 500px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <div class="report-container">
        <div class="report-header">
            <h1>HIVE DIAGNOSTIC REPORT</h1>
            <p>Generated by Kanasu Bee House ML Core</p>
        </div>

        <div id="statusIndicator" class="status-bar status-healthy">
            Status: Analyzing Data...
        </div>

        <div class="content">
            <div style="margin-bottom: 25px;">
                <h2 id="hName" style="font-size: 24px; font-weight: 800;">‚Äî</h2>
                <p id="rTime" style="color: #64748b; font-size: 13px;">‚Äî</p>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <label>Temperature</label>
                    <span id="rTemp">‚Äî</span>
                </div>
                <div class="info-item">
                    <label>Humidity</label>
                    <span id="rHum">‚Äî</span>
                </div>
                <div class="info-item">
                    <label>Acoustic (ML)</label>
                    <span id="rSound">‚Äî</span>
                </div>
                <div class="info-item">
                    <label>Net Weight</label>
                    <span id="rWeight">‚Äî</span>
                </div>
            </div>

            <div class="insight-box">
                <h3>üí° Acoustic ML Prediction</h3>
                <p id="mlInsight" style="font-size: 14px; color: #5a4a2f;">
                    Scanning frequencies for anomalies...
                </p>
            </div>

            <div id="imageRecommendation" style="display:none; margin-top: 15px; font-size: 13px; color: var(--danger); font-weight: 600;">
                ‚ö†Ô∏è Recommendation: Sound patterns suggest potential stress. Please proceed to Image-based detection.
            </div>

            <div class="actions">
                <button class="btn btn-print" onclick="window.print()">Download PDF</button>
                <a href="camera_upload.html" class="btn btn-camera">Visual Check (Image ML)</a>
            </div>
        </div>
    </div>

    <script>
        const hiveId = new URLSearchParams(window.location.search).get("hive");

        firebase.auth().onAuthStateChanged(user => {
            if (!user || !hiveId) return;

            // Fetch Hive Name
            firebase.database().ref(`userDashboards/${user.uid}/${hiveId}`).once("value").then(s => {
                hName.innerText = s.val() ? .name || "Unknown Hive";
            });

            // Fetch Latest Sensor Data
            firebase.database().ref(`hiveData/${hiveId}`).limitToLast(1).on("value", s => {
                if (!s.exists()) return;

                s.forEach(child => {
                    const data = child.val();
                    rTemp.innerText = data.temperature + " ¬∞C";
                    rHum.innerText = data.humidity + " %";
                    rSound.innerText = data.sound + " dB";
                    rWeight.innerText = data.weight + " kg";
                    rTime.innerText = new Date(data.timestamp || Date.now()).toLocaleString();

                    // Logic for Disease Prediction based on Sound/Temp
                    analyzeHiveHealth(data);
                });
            });
        });

        function analyzeHiveHealth(data) {
            const indicator = document.getElementById('statusIndicator');
            const insight = document.getElementById('mlInsight');
            const rec = document.getElementById('imageRecommendation');

            // Example ML Logic: If sound > 85dB or Temp > 38C, trigger warning
            if (data.sound > 85 || data.temperature > 38) {
                indicator.innerText = "Status: Warning - Action Required";
                indicator.className = "status-bar status-warning";
                insight.innerText = "Abnormal acoustic frequency detected. This may indicate swarm stress or early-stage disease.";
                rec.style.display = "block";
            } else {
                indicator.innerText = "Status: Healthy / Optimal";
                indicator.className = "status-bar status-healthy";
                insight.innerText = "Acoustic signatures are stable. Hive activity is normal for current climate conditions.";
                rec.style.display = "none";
            }
        }
    </script>
</body>

</html>